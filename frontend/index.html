<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SmartWaste Challenge</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .card.waste-input {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
        }

        .card.leaderboard {
            background: linear-gradient(135deg, #2196F3, #42A5F5);
            color: white;
        }

        .card.daily-challenge {
            background: linear-gradient(135deg, #FF9800, #FFB74D);
            color: white;
        }

        .card-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        .card h2 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .card p {
            font-size: 1.1rem;
            opacity: 0.9;
            line-height: 1.6;
        }

        /* Detail sections - initially hidden */
        .detail-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .detail-section.active {
            display: block;
        }

        .detail-section h2 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2196F3;
        }

        button {
            background: linear-gradient(135deg, #2196F3, #42A5F5);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        button.success {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
        }

        button.danger {
            background: linear-gradient(135deg, #f44336, #ef5350);
        }

        .back-btn {
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 1rem;
            font-size: 14px;
        }

        .back-btn:hover {
            background: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .challenges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .challenge-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #FF9800;
        }

        .challenge-card h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .challenge-card p {
            color: #666;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>SmartWaste Challenge</h1>
        </div>

        <!-- Main Dashboard Grid -->
        <div id="main-dashboard" class="main-grid">
            <div class="card waste-input" onclick="showWasteInput()">
                <span class="card-icon">üå±</span>
                <h2>Waste Input</h2>
                <p>Laporkan sampah harian Anda dan dapatkan poin eco-friendly</p>
            </div>

            <div class="card leaderboard" onclick="showLeaderboard()">
                <span class="card-icon">üèÜ</span>
                <h2>Leaderboard</h2>
                <p>Lihat ranking dan kompetisi dengan warga lainnya</p>
            </div>

            <div class="card daily-challenge" onclick="showDailyChallenge()">
                <span class="card-icon">‚ö°</span>
                <h2>Daily Challenge</h2>
                <p>Selesaikan tantangan harian untuk bonus poin</p>
            </div>
        </div>

        <!-- Waste Input Detail Section -->
        <div id="waste-input-section" class="detail-section">
            <button class="back-btn" onclick="showMainDashboard()">‚Üê Kembali ke Dashboard</button>
            <h2>üìä Lapor Sampah Harian</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Tanggal</label>
                    <input type="date" id="date" />
                </div>
                <div class="form-group">
                    <label>Organik (kg)</label>
                    <input type="number" id="organic" step="0.1" min="0" max="50" placeholder="0.0" />
                </div>
                <div class="form-group">
                    <label>Plastik (kg)</label>
                    <input type="number" id="plastic" step="0.1" min="0" max="50" placeholder="0.0" />
                </div>
                <div class="form-group">
                    <label>Elektronik (kg)</label>
                    <input type="number" id="electronic" step="0.1" min="0" max="50" placeholder="0.0" />
                </div>
                <div class="form-group">
                    <label>Lainnya (kg)</label>
                    <input type="number" id="other" step="0.1" min="0" max="50" placeholder="0.0" />
                </div>
            </div>
            <button id="submit">‚ú® Submit Laporan</button>
            <button onclick="classifyWaste()" class="success" style="margin-left: 1rem;">ü§ñ AI Classify</button>
            
            <div id="ai-classification" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f0f8ff; border-radius: 10px;">
                <h3>ü§ñ AI Classification Result</h3>
                <div id="ai-result"></div>
            </div>
        </div>

        <!-- Leaderboard Detail Section -->
        <div id="leaderboard-section" class="detail-section">
            <button class="back-btn" onclick="showMainDashboard()">‚Üê Kembali ke Dashboard</button>
            <h2>üèÜ Leaderboard</h2>
            <table id="leaderboard">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Total Points</th>
                        <th>Laporan Approved</th>
                        <th>Laporan Pending</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Daily Challenge Detail Section -->
        <div id="daily-challenge-section" class="detail-section">
            <button class="back-btn" onclick="showMainDashboard()">‚Üê Kembali ke Dashboard</button>
            <h2>‚ö° Daily Challenges</h2>
            <div id="challenges" class="challenges-grid"></div>
        </div>

        <!-- Pengurus Panel -->
        <div id="pengurus-section" class="detail-section">
            <button class="back-btn" onclick="showMainDashboard()">‚Üê Kembali ke Dashboard</button>
            <h2>üë®‚Äçüíº Panel Pengurus</h2>
            <button id="load-pending" class="success">üìã Load Pending Reports</button>
            <table id="pending-table" style="display: none;">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Date</th>
                        <th>Organic</th>
                        <th>Plastic</th>
                        <th>Electronic</th>
                        <th>Other</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const api = 'http://localhost:4000';

        // Navigation functions
        function showMainDashboard() {
            document.getElementById('main-dashboard').style.display = 'grid';
            document.querySelectorAll('.detail-section').forEach(section => {
                section.classList.remove('active');
            });
        }

        function showWasteInput() {
            document.getElementById('main-dashboard').style.display = 'none';
            document.getElementById('waste-input-section').classList.add('active');
            
            // Set today's date as default
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('date').value = today;
        }

        function showLeaderboard() {
            document.getElementById('main-dashboard').style.display = 'none';
            document.getElementById('leaderboard-section').classList.add('active');
            loadLeaderboard();
        }

        function showDailyChallenge() {
            document.getElementById('main-dashboard').style.display = 'none';
            document.getElementById('daily-challenge-section').classList.add('active');
            loadChallenges();
        }

        // Load data functions
        async function loadLeaderboard() {
            try {
                const r = await fetch(api + '/leaderboard');
                const data = await r.json();
                const tbody = document.querySelector('#leaderboard tbody');
                tbody.innerHTML = '';
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${row.name}</td><td>${row.total_points}</td><td>${row.approved_reports}</td><td>${row.pending_reports}</td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        async function loadChallenges() {
            try {
                const r = await fetch(api + '/challenges');
                const data = await r.json();
                const div = document.getElementById('challenges');
                div.innerHTML = '';
                data.forEach(ch => {
                    const el = document.createElement('div');
                    el.className = 'challenge-card';
                    el.innerHTML = `
                        <h3>üéØ ${ch.title}</h3>
                        <p>${ch.description}</p>
                        <button data-id="${ch.id}" class="success">‚ú® Selesaikan ( +${ch.points} pts)</button>
                    `;
                    el.querySelector('button').addEventListener('click', async () => {
                        const payload = { rt_id: 1, challenge_id: ch.id }; // Default RT ID
                        const res = await fetch(api + '/challenges/complete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        const j = await res.json();
                        if (j.awarded) {
                            alert('üéâ Challenge selesai! Points awarded: ' + j.awarded);
                            loadLeaderboard();
                        } else {
                            alert('‚ùå Error: ' + (j.error || 'unknown'));
                        }
                    });
                    div.appendChild(el);
                });
            } catch (error) {
                console.error('Error loading challenges:', error);
            }
        }

        async function loadPendingReports() {
            try {
                // Remove auth check - allow anyone to see pending reports
                const res = await fetch(`${api}/pending-reports/1?pengurus_id=1`); // Default RT and pengurus ID
                const reports = await res.json();

                const table = document.getElementById('pending-table');
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';

                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No pending reports</td></tr>';
                } else {
                    reports.forEach(report => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
              <td>${report.user_name}</td>
              <td>${report.date}</td>
              <td>${report.organic}</td>
              <td>${report.plastic}</td>
              <td>${report.electronic}</td>
              <td>${report.other}</td>
              <td>
                <button onclick="approveReport(${report.id}, 'approve')" class="success">Approve</button>
                <button onclick="approveReport(${report.id}, 'reject')" class="danger">Reject</button>
              </td>
            `;
                        tbody.appendChild(tr);
                    });
                }

                table.style.display = 'table';
            } catch (error) {
                console.error('Error loading pending reports:', error);
            }
        }

        async function approveReport(reportId, action) {
            try {
                const res = await fetch(`${api}/approve-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ report_id: reportId, pengurus_id: 1, action }) // Default pengurus ID
                });

                const result = await res.json();
                if (result.success) {
                    alert(`Report ${action}d successfully!`);
                    loadPendingReports();
                    loadLeaderboard();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error approving report:', error);
                alert('Error approving report');
            }
        }

        async function classifyWaste() {
            const organic = Number(document.getElementById('organic').value) || 0;
            const plastic = Number(document.getElementById('plastic').value) || 0;
            const electronic = Number(document.getElementById('electronic').value) || 0;
            const other = Number(document.getElementById('other').value) || 0;

            if (organic + plastic + electronic + other === 0) {
                alert('Masukkan data sampah terlebih dahulu');
                return;
            }

            try {
                const res = await fetch(api + '/classify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ organic, plastic, electronic, other })
                });
                const result = await res.json();

                document.getElementById('ai-result').innerHTML = `
                    <p><strong>Kategori Dominan:</strong> ${result.dominantCategory}</p>
                    <p><strong>Eco Score:</strong> ${result.ecoScore}/100</p>
                    <p><strong>Rekomendasi:</strong> ${result.recommendation}</p>
                `;
                document.getElementById('ai-classification').style.display = 'block';
            } catch (error) {
                console.error('Classification error:', error);
                alert('Error during classification');
            }
        }

        // Event listeners
        document.getElementById('submit').addEventListener('click', async () => {
            const payload = {
                user_id: 1, // Default user ID
                date: document.getElementById('date').value || new Date().toISOString().slice(0, 10),
                organic: Number(document.getElementById('organic').value),
                plastic: Number(document.getElementById('plastic').value),
                electronic: Number(document.getElementById('electronic').value),
                other: Number(document.getElementById('other').value)
            };

            try {
                const res = await fetch(api + '/report', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const j = await res.json();
                if (j.success) {
                    alert('‚úÖ Laporan berhasil dikirim!');
                    // Clear form
                    document.getElementById('organic').value = '';
                    document.getElementById('plastic').value = '';
                    document.getElementById('electronic').value = '';
                    document.getElementById('other').value = '';
                    document.getElementById('ai-classification').style.display = 'none';
                } else {
                    alert('‚ùå Error: ' + j.error);
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('‚ùå Error submitting report');
            }
        });

        document.getElementById('load-pending').addEventListener('click', loadPendingReports);

        // Initialize - show pengurus section by default on main dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Add pengurus panel to main dashboard
            const mainGrid = document.getElementById('main-dashboard');
            const pengurusCard = document.createElement('div');
            pengurusCard.className = 'card';
            pengurusCard.style.background = 'linear-gradient(135deg, #9C27B0, #BA68C8)';
            pengurusCard.style.color = 'white';
            pengurusCard.onclick = () => {
                document.getElementById('main-dashboard').style.display = 'none';
                document.getElementById('pengurus-section').classList.add('active');
            };
            pengurusCard.innerHTML = `
                <span class="card-icon">üë®‚Äçüíº</span>
                <h2>Panel Pengurus</h2>
                <p>Kelola dan approve laporan dari warga</p>
            `;
            mainGrid.appendChild(pengurusCard);
        });
    </script>
</body>
</html>
